---
# PostgreSQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
  namespace: nexus
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15
        ports:
        - containerPort: 5432
          name: postgres
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_DB
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - user
            - -d
            - academic_db
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - user
            - -d
            - academic_db
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
      - name: init-script
        configMap:
          name: postgres-init-script

---
# SQL Validator API Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sql-validator-api-deployment
  namespace: nexus
  labels:
    app: sql-validator-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: sql-validator-api
  template:
    metadata:
      labels:
        app: sql-validator-api
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.35
        command: ['sh', '-c', 'until nc -z postgres-service 5432; do echo waiting for postgres; sleep 2; done;']
      containers:
      - name: api
        image: trahulprabhu38/sql-validator:v1-linux
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
          name: http
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: sql-validator-secrets
              key: POSTGRES_DB
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: sql-validator-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: sql-validator-config
              key: DB_PORT
        - name: DB_URI
          value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(POSTGRES_DB)"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /docs
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /docs
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
# PersistentVolumeClaim for PostgreSQL (using dynamic provisioning)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: nexus
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  # storageClassName will use the default storage class if not specified
  # For minikube, this is typically 'standard'
  # For cloud providers (GKE, EKS, AKS), they have default storage classes

---
# ConfigMap for init.sql script
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: nexus
data:
  init.sql: |
    -- Create tables
    CREATE TABLE IF NOT EXISTS Student (
        student_id SERIAL PRIMARY KEY,
        name VARCHAR(100),
        email VARCHAR(100),
        year INT CHECK (year BETWEEN 1 AND 4),
        semester INT CHECK (semester BETWEEN 1 AND 8),
        department VARCHAR(50)
    );

    CREATE TABLE IF NOT EXISTS Semester (
        semester_id SERIAL PRIMARY KEY,
        year INT CHECK (year BETWEEN 1 AND 4),
        semester INT CHECK (semester BETWEEN 1 AND 8),
        start_date DATE,
        end_date DATE
    );

    CREATE TABLE IF NOT EXISTS Subjects (
        subject_id SERIAL PRIMARY KEY,
        name VARCHAR(100),
        semester_id INT REFERENCES Semester(semester_id),
        credits INT
    );

    CREATE TABLE IF NOT EXISTS Marks (
        mark_id SERIAL PRIMARY KEY,
        student_id INT REFERENCES Student(student_id),
        subject_id INT REFERENCES Subjects(subject_id),
        marks INT,
        grade CHAR(2),
        semester_id INT REFERENCES Semester(semester_id)
    );

    CREATE TABLE IF NOT EXISTS Timetable (
        timetable_id SERIAL PRIMARY KEY,
        semester_id INT REFERENCES Semester(semester_id),
        day VARCHAR(10),
        time TIME,
        subject_id INT REFERENCES Subjects(subject_id),
        room VARCHAR(20)
    );

    -- Insert sample data
    INSERT INTO Student (name, email, year, semester, department)
    VALUES
        ('Alice', 'alice@dsc.edu', 1, 1, 'CSE'),
        ('Bob', 'bob@dsc.edu', 2, 3, 'AIML'),
        ('Charlie', 'charlie@dsc.edu', 1, 2, 'ECE'),
        ('David', 'david@dsc.edu', 3, 5, 'CSE'),
        ('Eve', 'eve@dsc.edu', 4, 7, 'IT')
    ON CONFLICT DO NOTHING;

    INSERT INTO Semester (year, semester, start_date, end_date)
    VALUES
        (1, 1, '2025-01-10', '2025-05-10'),
        (1, 2, '2025-08-01', '2025-12-15'),
        (2, 3, '2025-01-10', '2025-05-10'),
        (2, 4, '2025-08-01', '2025-12-15')
    ON CONFLICT DO NOTHING;

    INSERT INTO Subjects (name, semester_id, credits)
    VALUES
        ('Math I', 1, 4),
        ('Programming Fundamentals', 1, 3),
        ('Physics I', 1, 4),
        ('Electronics I', 2, 3),
        ('Discrete Mathematics', 2, 4)
    ON CONFLICT DO NOTHING;

